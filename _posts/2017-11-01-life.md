---
layout: post
title: 2017年11月
category: 技术
comments: true
---


## 随笔-11
距离上次写blog已经四个月了。这四个月中产品发布几次版本，苏州出差一次，北京出差一次。每次都在10天左右。很忙，有时间总想定下来写点东西，但是就是无法坐下来，总是在查问题，思考问题。
###主要两件事情
	1、平台接口工作，现场问题分析定位
	2、苏州云平台三家厂商互联互通

平台接口方面处理平台一些相关需求，问题。随着两次出差，及各产品反馈的问题，使我慢慢了解到平台许多改进，有一些问题只是暂时没有暴露出来。其中有一个问题，有一个不经常使用的服务在1台机器上的CPU占用特别高，通过lsof -i：XXXX查看连接数已达到900多个，正常应该只是300左右，最终反馈给家里，家里分析出问题。查看现场所有前置处理器的CPU发现，普遍CPU占用在30多，通过查找资料，最终在github上找到一位牛人分享查询linux下CPU占用高的线程高的方法。[https://github.com/bangerlee/strace_pstack](https://github.com/bangerlee/strace_pstack)。也遇到一些奇葩的问题，通过system启动进程经过运行几天偶尔进程消失，系统日志无内容记录等等


苏州云平台调试，Modbus主站，子站，104的主站，子站。调试了4遥。主要问题如下几种，此外本次出差和其他两个同行竞争单位测试互联互通(1家单位软件自助研发，1家单位软件是使用国外)，也看到本公司软件优势和改进项。
	
	调试中主要遇到一些问题：
	1、双方网络通信是否正常（注意A网和B网，当时搭建A网和B网没有设置网关，A网可以ping通，结果Modbus走了B网，临时禁制B网）。
	2、双方端口是否一致，502，503
	3、双方的设备地址是否一致。
	4、双方寄存器是从1开始，还是从0开始
	5、通过wireshark抓包查看是否有回复
	6、104 我方通过一只发送总召唤，判断链路是否通断，结果对端使用的模拟软件不回复总召唤。
	7、双方请求功能码是否一致，是保持寄存器(3，地址已4开头）还是输入寄存器（4,地址已3开头)
	下发指令的功能码是6，还是16(0x10)
	8、对于子站，我方回复报文是否正确

modbus tcp数据报文结构，引用1个CSDN的1个博客，写的很精辟。
	
	modbus tcp数据报文结构
	读取数据请求：00 01 00 00 00 06 18 03 00 02 00 02
	 
	数据
	含义
	00 01
	此次通信事务处理标识符，一般每次通信之后将被要求加1以区别不同的通信数据报文
	00 00
	表示协议标识符，00 00为modbus协议
	00 06
	数据长度，用来指示接下来数据的长度，单位字
	18
	设备地址，用以标识连接在串行线或者网络上的远程服务端的地址。以上七个字节也被称为modbus报文头
	03
	功能码，此时代码03为读取保持寄存器数据
	00 02
	起始地址
	00 02
	寄存器数量，（word数量）
	 
	读取数据响应：00 01 00 00 00 05 18 03 02 12 34
	 
	数据
	含义
	00 01
	此次通信事务处理标识符，应答报文要求与先前对应的请求保持一致
	00 00
	协议标识符，与先前对应的请求保持一致
	00 05
	数据长度，用来指示接下来数据的长度，单位字节
	18
	设备地址，应答报文要求与先前对应的请求保持一致
	03
	正常情况下应答报文要求与先前对应的请求保持一致，如果出错则返回0x80+先前的功能码(读取错误码83)
	02
	接下来的数据的字节长度
	12 34
	被读取的保持寄存器中的数据值
	写入数据请求：00 01 00 00 00 11 18 10 00 00 00 05 0A 00 00 00 00 00 00 00 03 00 00
	 
	数据
	含义
	00 01
	此次通信事务处理标识符，一般每次通信之后将被要求加1以区别不同的通信数据报文
	00 00
	表示协议标识符，00 00为modbus协议
	00 11
	数据长度，用来指示接下来数据的长度，单位字节
	18
	设备地址，用以标识连接在串行线或者网络上的远程服务端的地址。以上七个字节也被称为modbus报文头
	10
	功能码，此时代码10为写入寄存器数据
	00 00
	起始地址
	00 05
	写寄存器数量
	0A
	写入数据的字节个数
	----
	写入的数据
	 
	写入数据响应：00 01 00 00 00 06 18 10 00 00 00 05
	 
	数据
	含义
	00 01
	此次通信事务处理标识符，应答报文要求与先前对应的请求保持一致;
	00 00
	协议标识符，与先前对应的请求保持一致
	00 06
	数据长度，用来指示接下来数据的长度，单位字节
	18
	设备地址，应答报文要求与先前对应的请求保持一致
	10
	正常情况下应答报文要求与先前对应的请求保持一致，如果出错则返回0x80+先前的功能码(写入错误码90)
	00 00
	写入起始地址
	00 05
	写入寄存器长度
	 `

###工具
	Modbus:ModScan,Modsim,Modslave
	104：PMAV2.85、IECServer（jre-7u10-windows-i586）
	UDP\TCP:TCPUDPDebug102_Setup、TCP-UDP服务管理 V3.01
	串口：VSPD虚拟串口工具、Commtest、串口调试助手V2.1

	
###VS2010 远程调试
[VS2010远程调试环境详细配置(Windows用户验证)](http://blog.csdn.net/cbnotes/article/details/52813222)

[VS2010远程调试环境配置详细讲解](http://www.cnblogs.com/Braveliu/archive/2013/03/29/2989704.html)

[VS2010进行远程调试方法总结](http://blog.sina.com.cn/s/blog_a459dcf5010153o7.html)


###linux 命令
	ps : 查看进程
	ps -eH ：查看进程，父子关系
	ps -aux ：查看进程，可以查看进程状态，如睡眠状态进程，无法通过kill -9杀死
	top
	top -H -p 进程号:查看进程中那个线程CPU占用高，可以结果pstack, gdb 查看堆栈
	date
	ls -l
	grep -rin findcontents * ：在当前目录下的文件中查看findcontents内容
    find . -name "*.cpp" :查找文件

	

###内存分析工具
	1、LeakDiag和LDGrapher
	2、UMDH
	3、性能拷机
	4、二分法

###windows CPU查看工具
	1、ProcessExplorer
	2、VS2010旗舰版的性能分析工具
	3、代码走查，死循环，未进行sleep
	4、大量计算，调用频率高。
	5、加锁位置不当等


这段时间解决几个疑难的Bug，使用理解一个道理，一定要沉下心来，认真分析，认真尝试，总是会复现的，总是会找出原因的。
	

----------

						搂起袖子加油干
							不忘初心
								位卑未敢忘国忧
						一勤天下无难事
							不日新者必自退
								天行健，君子以自强不息


